# データ永続化テスト機能

このドキュメントでは、Identity V Tournament システムのデータ永続化とテスト機能について説明します。

## 問題の解決

### 以前の問題
- サーバー再起動時にデータが消失していた
- 試合進行のテストが困難だった
- 大会データの永続化が不十分だった

### 解決策
1. **ファイルベース永続化システム**: メモリベースの模擬データベースからファイルベースに変更
2. **包括的なテスト機能**: 試合シミュレーション、大会進行テストを追加
3. **充実したサンプルデータ**: 実際の大会シナリオを模擬したテストデータ

## 新機能

### 1. データ永続化システム
- **場所**: `/data/` ディレクトリにJSON形式で保存
- **対象データ**: 大会、試合結果、シリーズ、ユーザー、エントリー、設定
- **自動バックアップ**: 開発時にバックアップ作成機能

#### 永続化されるデータ
```
data/
├── tournaments.json     # 大会情報
├── matchResults.json    # 試合結果
├── series.json         # シリーズ情報
├── users.json          # ユーザー情報
├── entries.json        # エントリー情報
├── settings.json       # システム設定
└── backups/            # バックアップファイル
```

### 2. 大会システムシミュレーター
**URL**: `/test/tournament-simulator`

#### 機能
- **ランダム試合生成**: キャラクター、結果をランダムに生成
- **シリーズ管理**: BO1/BO3/BO5形式のシリーズ作成
- **データ管理**: バックアップ作成、データクリア
- **リアルタイム状況表示**: 進行中の大会・シリーズ状況

#### 使用方法
1. 大会シミュレーターにアクセス
2. 「ランダム試合生成」で自動試合作成
3. 手動でシリーズ作成も可能
4. 結果は即座に保存され、再起動後も保持

### 3. 試合結果表示システム
**URL**: `/test/results`

#### 表示内容
- 試合タイトルとスコア
- ハンター・サバイバー詳細情報
- 使用キャラクター（日本語名表示）
- 試合統計（吊り数、逃げ数、記録時刻）
- 試合メモ・備考

### 4. キャラクター追跡テスト
**URL**: `/test/character-form`

#### 機能
- 手動試合結果入力
- キャラクター選択機能
- 大会・シリーズ紐付け
- 詳細なメモ記録

## サンプルデータ

### 大会
1. **サンプル大会 - 初心者歓迎** (最大20チーム、5人制)
2. **最高峰限定大会** (最大16チーム、4人制)

### シリーズ
1. **準決勝 BO3**: チームA vs チームB (完了)
2. **決勝 BO5**: 最強チーム vs エリートチーム (進行中)

### 試合結果
- 準決勝3試合の詳細結果
- 決勝戦第1試合
- 練習試合・シミュレーション試合

## API エンドポイント

### 開発用エンドポイント
- `GET /dev/stats` - データベース統計情報
- `POST /test/simulate-match` - ランダム試合生成
- `POST /test/create-test-series` - テストシリーズ作成
- `POST /test/backup-data` - データバックアップ作成
- `POST /test/clear-match-data` - 試合データクリア

### 試合結果管理
- `GET /test/results` - 試合結果一覧表示
- `POST /test/match-results` - 手動試合結果追加

## 技術仕様

### 永続化機能
- **実装**: `PersistentMockFirestore` クラス
- **データ形式**: JSON（日付オブジェクトの適切なシリアライゼーション）
- **同期**: 書き込み時に即座にファイル保存

### セッション永続化
- **開発環境**: ファイルベースセッションストレージ
- **本番環境**: Firestore セッションストレージ
- **利点**: ログイン状態がサーバー再起動後も保持

## 使用例

### 1. 大会進行テスト
```bash
# 1. サーバー起動
npm start

# 2. 大会シミュレーターでランダム試合生成
curl -X POST http://localhost:3000/test/simulate-match \
  -H "Content-Type: application/json" \
  -d '{"tournamentId":"sample-tournament"}'

# 3. 結果確認
curl http://localhost:3000/test/results
```

### 2. データ永続化確認
```bash
# 1. データ状況確認
curl http://localhost:3000/dev/stats

# 2. サーバー再起動
npm restart

# 3. データが保持されていることを確認
curl http://localhost:3000/dev/stats
```

### 3. バックアップ作成
```bash
# バックアップ作成
curl -X POST http://localhost:3000/test/backup-data
```

## 注意事項

### 開発環境限定機能
以下の機能は `NODE_ENV=development` でのみ利用可能：
- データクリア機能
- バックアップ作成
- 開発統計エンドポイント

### データファイル管理
- `data/` ディレクトリは `.gitignore` に含まれている
- 本番環境では実際のFirestoreを使用する
- バックアップファイルは `data/backups/` に自動保存

## トラブルシューティング

### データが保存されない場合
1. `data/` ディレクトリの書き込み権限を確認
2. ディスク容量を確認
3. ログでエラーメッセージを確認

### 文字化け・表示問題
- キャラクター名は `characters.js` で管理
- 日本語表示は `getCharacterName()` 関数で処理

このシステムにより、安定したデータ永続化と包括的なテスト環境が提供され、大会システムの開発・テストが効率的に行えます。