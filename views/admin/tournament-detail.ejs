<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= tournament.title %> - ç®¡ç†ç”»é¢ | Identity V Match</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-brand">
                <h1><a href="/">Identity V Match</a></h1>
            </div>
            <div class="nav-links">
                <a href="/tournaments">å¤§ä¼šä¸€è¦§</a>
                <a href="/admin" class="active">ç®¡ç†ç”»é¢</a>
                <a href="/auth/logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="admin-header">
            <div class="tournament-title-section">
                <h1>ğŸ† <%= tournament.title %> - ç®¡ç†ç”»é¢</h1>
                <div class="tournament-status">
                    <span class="status-badge status-<%= tournament.status %>">
                        <%= tournament.status === 'open' ? 'å‹Ÿé›†ä¸­' : 
                            tournament.status === 'closed' ? 'ç· åˆ‡' : 
                            tournament.status === 'ongoing' ? 'é–‹å‚¬ä¸­' : 
                            tournament.status === 'finished' ? 'çµ‚äº†' : tournament.status %>
                    </span>
                </div>
            </div>
            <div class="admin-actions">
                <a href="/tournaments/<%= tournament.id %>" class="btn btn-outline">å…¬é–‹ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º</a>
                <a href="/admin/tournaments" class="btn btn-secondary">å¤§ä¼šä¸€è¦§ã«æˆ»ã‚‹</a>
            </div>
        </div>

        <div class="admin-content">
            <!-- Tournament Info Section -->
            <div class="info-section">
                <div class="info-card">
                    <h3>ğŸ“‹ å¤§ä¼šæƒ…å ±</h3>
                    <div class="info-list">
                        <div class="info-item">
                            <span class="info-label">æœ€å¤§å‚åŠ è€…æ•°</span>
                            <span class="info-value"><%= tournament.maxEntries %>äºº</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ¨å¥¨ãƒãƒ¼ãƒ ã‚µã‚¤ã‚º</span>
                            <span class="info-value"><%= tournament.teamSize %>äºº (4-7äººç·¨æˆå¯èƒ½)</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç· åˆ‡</span>
                            <span class="info-value"><%= formatDate(tournament.entryDeadline) %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ç¾åœ¨ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°</span>
                            <span class="info-value"><%= entries.length %>äºº</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ãƒãƒ¼ãƒ æ•°</span>
                            <span class="info-value"><%= teams.length %>ãƒãƒ¼ãƒ </span>
                        </div>
                    </div>
                </div>

                <!-- Status Management -->
                <div class="info-card">
                    <h3>ğŸ® å¤§ä¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</h3>
                    <div class="status-controls">
                        <button onclick="updateStatus('open')" class="btn btn-success" 
                                <%= tournament.status === 'open' ? 'disabled' : '' %>>
                            å‹Ÿé›†é–‹å§‹
                        </button>
                        <button onclick="updateStatus('closed')" class="btn btn-warning"
                                <%= tournament.status === 'closed' ? 'disabled' : '' %>>
                            å‹Ÿé›†ç· åˆ‡
                        </button>
                        <button onclick="updateStatus('ongoing')" class="btn btn-primary"
                                <%= tournament.status === 'ongoing' ? 'disabled' : '' %>>
                            å¤§ä¼šé–‹å§‹
                        </button>
                        <button onclick="updateStatus('finished')" class="btn btn-secondary"
                                <%= tournament.status === 'finished' ? 'disabled' : '' %>>
                            å¤§ä¼šçµ‚äº†
                        </button>
                    </div>
                </div>
            </div>

            <!-- Participants Management -->
            <div class="participants-section">
                <div class="participants-card">
                    <h3>ğŸ‘¥ å‚åŠ è€…ç®¡ç† (<%= entries.length %>äºº)</h3>
                    <% if (entries.length > 0) { %>
                        <div class="participants-controls">
                            <button onclick="createRandomTeams()" class="btn btn-primary">
                                ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒ¼ãƒ ä½œæˆ
                            </button>
                            <button onclick="clearAllTeams()" class="btn btn-danger">
                                å…¨ãƒãƒ¼ãƒ è§£æ•£
                            </button>
                            <button onclick="exportParticipants()" class="btn btn-outline">
                                å‚åŠ è€…ãƒªã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                        </div>
                        
                        <div class="participants-list">
                            <% entries.forEach(entry => { %>
                                <div class="participant-item" id="participant-<%= entry.id %>">
                                    <div class="participant-info">
                                        <span class="participant-name"><%= entry.username %></span>
                                        <div class="participant-ranks">
                                            <span class="rank-badge hunter">H: <%= entry.hunterRank %>æ®µ</span>
                                            <span class="rank-badge survivor">S: <%= entry.survivorRank %>æ®µ</span>
                                        </div>
                                    </div>
                                    <div class="participant-actions">
                                        <button onclick="removeParticipant('<%= entry.id %>')" 
                                                class="btn btn-sm btn-danger">å‰Šé™¤</button>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p class="no-participants">ã¾ã å‚åŠ è€…ãŒã„ã¾ã›ã‚“</p>
                    <% } %>
                </div>
            </div>

            <!-- Teams Management -->
            <div class="teams-section">
                <div class="teams-card">
                    <h3>ğŸ¯ ãƒãƒ¼ãƒ ç®¡ç† (<%= teams.length %>ãƒãƒ¼ãƒ )</h3>
                    <div class="team-info-note">
                        <p>ğŸ’¡ ãƒãƒ¼ãƒ ç·¨æˆã¯4ã€œ7äººã§æ§‹æˆå¯èƒ½ã§ã™ã€‚å…¨ã¦ã®ãƒãƒ¼ãƒ ãŒåŒã˜äººæ•°ã§ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    </div>
                    
                    <% if (teams.length > 0) { %>
                        <div class="teams-list">
                            <% teams.forEach((team, index) => { %>
                                <div class="team-item" id="team-<%= team.id %>">
                                    <div class="team-header">
                                        <h4>ãƒãƒ¼ãƒ  <%= index + 1 %> (<%= team.members ? team.members.length : 0 %>äºº)</h4>
                                        <div class="team-actions">
                                            <button onclick="editTeam('<%= team.id %>')" class="btn btn-sm btn-primary">ç·¨é›†</button>
                                            <button onclick="deleteTeam('<%= team.id %>')" class="btn btn-sm btn-danger">å‰Šé™¤</button>
                                        </div>
                                    </div>
                                    <% if (team.members && team.members.length > 0) { %>
                                        <div class="team-members">
                                            <% team.members.forEach(member => { %>
                                                <div class="team-member">
                                                    <span class="member-name"><%= member.username %></span>
                                                    <div class="member-ranks">
                                                        <span class="rank-badge hunter">H: <%= member.hunterRank %>æ®µ</span>
                                                        <span class="rank-badge survivor">S: <%= member.survivorRank %>æ®µ</span>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        </div>
                                    <% } else { %>
                                        <p class="no-members">ãƒ¡ãƒ³ãƒãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                    <% } %>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <div class="no-teams">
                            <p>ã¾ã ãƒãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                            <% if (entries.length >= 4) { %>
                                <button onclick="createRandomTeams()" class="btn btn-primary">
                                    ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒ¼ãƒ ä½œæˆ
                                </button>
                            <% } else { %>
                                <p class="note">ãƒãƒ¼ãƒ ä½œæˆã«ã¯æœ€ä½4äººã®å‚åŠ è€…ãŒå¿…è¦ã§ã™</p>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </main>

    <style>
        .admin-header {
            margin-bottom: 3rem;
        }

        .tournament-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tournament-title-section h1 {
            color: #f39c12;
            font-size: 2.2rem;
        }

        .admin-actions {
            display: flex;
            gap: 1rem;
        }

        .admin-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .teams-section {
            grid-column: 1 / -1;
        }

        .info-card, .participants-card, .teams-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 2rem;
        }

        .info-card h3, .participants-card h3, .teams-card h3 {
            color: #f39c12;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .info-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-label {
            font-weight: bold;
            opacity: 0.8;
        }

        .info-value {
            color: #f39c12;
            font-weight: bold;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-open { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .status-closed { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .status-ongoing { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .status-finished { background: linear-gradient(45deg, #7f8c8d, #95a5a6); }

        .status-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .participants-controls {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .participants-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .participant-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .participant-ranks {
            display: flex;
            gap: 0.5rem;
        }

        .rank-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .rank-badge.hunter {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .rank-badge.survivor {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .team-info-note {
            background: rgba(52, 152, 219, 0.2);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border-left: 4px solid #3498db;
        }

        .team-info-note p {
            margin: 0;
            color: #3498db;
        }

        .teams-list {
            display: grid;
            gap: 1.5rem;
        }

        .team-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 15px;
            border: 2px solid rgba(243, 156, 18, 0.3);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .team-header h4 {
            color: #f39c12;
            margin: 0;
        }

        .team-actions {
            display: flex;
            gap: 0.5rem;
        }

        .team-members {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .team-member {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
        }

        .member-name {
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }

        .member-ranks {
            display: flex;
            gap: 0.5rem;
        }

        .no-participants, .no-members, .no-teams {
            text-align: center;
            opacity: 0.6;
            font-style: italic;
            padding: 2rem;
        }

        .no-teams .note {
            color: #f39c12;
            margin-top: 1rem;
        }
        
        /* Modal Styles for Team Editing */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #2c3e50;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header h3 {
            margin: 0;
            color: #f39c12;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #ecf0f1;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(231, 76, 60, 0.2);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ecf0f1;
            font-weight: bold;
        }
        
        .form-group input[type="text"] {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #ecf0f1;
            font-size: 1rem;
        }
        
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .member-selection {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .member-option {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: background 0.3s;
        }
        
        .member-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .member-option input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.2);
        }
        
        .member-option label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            cursor: pointer;
            margin: 0;
        }
        
        .member-option .member-name {
            font-weight: bold;
            color: #ecf0f1;
        }
        
        .member-option .member-ranks {
            display: flex;
            gap: 0.5rem;
        }
        
        .member-count {
            margin-top: 1rem;
            text-align: center;
            font-weight: bold;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-actions .btn {
            padding: 0.8rem 1.5rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .admin-content {
                grid-template-columns: 1fr;
            }
            
            .tournament-title-section {
                flex-direction: column;
                gap: 1rem;
            }

            .admin-actions {
                justify-content: center;
            }

            .status-controls, .participants-controls {
                justify-content: center;
            }

            .team-members {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        async function updateStatus(newStatus) {
            if (!confirm(`å¤§ä¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${getStatusText(newStatus)}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        async function removeParticipant(participantId) {
            if (!confirm('ã“ã®å‚åŠ è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/participants/${participantId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('å‚åŠ è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('å‚åŠ è€…å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        async function createRandomTeams() {
            if (!confirm('ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®ãƒãƒ¼ãƒ ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/teams/random`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert(`${result.teamsCreated}å€‹ã®ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ`);
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ãƒãƒ¼ãƒ ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        async function clearAllTeams() {
            if (!confirm('å…¨ã¦ã®ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/teams`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('å…¨ã¦ã®ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ãƒãƒ¼ãƒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        async function deleteTeam(teamId) {
            if (!confirm('ã“ã®ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/teams/${teamId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ãƒãƒ¼ãƒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        function editTeam(teamId) {
            // Get team data and show edit modal
            showEditTeamModal(teamId);
        }
        
        async function showEditTeamModal(teamId) {
            try {
                // Get team data
                const response = await fetch(`/api/teams/${teamId}/members`);
                const result = await response.json();
                
                if (!response.ok) {
                    alert('Error: ' + result.error);
                    return;
                }
                
                // Get all tournament participants for selection
                const tournamentEntries = <%-JSON.stringify(entries)%>;
                
                // Show modal
                openTeamEditModal(result.teamId, result.teamName, result.members, tournamentEntries);
            } catch (error) {
                alert('ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }
        
        function openTeamEditModal(teamId, teamName, currentMembers, allEntries) {
            // Create modal HTML
            const modalHtml = `
                <div id="editTeamModal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ğŸ¯ ãƒãƒ¼ãƒ ç·¨é›†</h3>
                            <button onclick="closeEditTeamModal()" class="close-btn">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <form id="editTeamForm">
                                <input type="hidden" id="editTeamId" value="${teamId}">
                                <div class="form-group">
                                    <label for="editTeamName">ãƒãƒ¼ãƒ å</label>
                                    <input type="text" id="editTeamName" value="${teamName}" required>
                                </div>
                                <div class="form-group">
                                    <label>ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ (4-7äºº)</label>
                                    <div class="member-selection">
                                        ${allEntries.map(entry => `
                                            <div class="member-option">
                                                <input type="checkbox" 
                                                       id="member_${entry.discordId}" 
                                                       value="${entry.discordId}"
                                                       ${currentMembers.some(m => m.discordId === entry.discordId) ? 'checked' : ''}>
                                                <label for="member_${entry.discordId}">
                                                    <span class="member-name">${entry.username}</span>
                                                    <span class="member-ranks">
                                                        <span class="rank-badge hunter">H: ${entry.hunterRank}æ®µ</span>
                                                        <span class="rank-badge survivor">S: ${entry.survivorRank}æ®µ</span>
                                                    </span>
                                                </label>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="member-count">é¸æŠä¸­: <span id="selectedCount">0</span>äºº</div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" onclick="closeEditTeamModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Add event listeners
            setupTeamEditModal();
        }
        
        function setupTeamEditModal() {
            const checkboxes = document.querySelectorAll('#editTeamModal input[type="checkbox"]');
            const countSpan = document.getElementById('selectedCount');
            const form = document.getElementById('editTeamForm');
            
            // Update count when checkboxes change
            function updateCount() {
                const checked = document.querySelectorAll('#editTeamModal input[type="checkbox"]:checked');
                countSpan.textContent = checked.length;
                countSpan.style.color = checked.length >= 4 && checked.length <= 7 ? '#27ae60' : '#e74c3c';
            }
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateCount);
            });
            
            // Initial count
            updateCount();
            
            // Form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveTeamEdit();
            });
        }
        
        async function saveTeamEdit() {
            const teamId = document.getElementById('editTeamId').value;
            const teamName = document.getElementById('editTeamName').value;
            const checkedBoxes = document.querySelectorAll('#editTeamModal input[type="checkbox"]:checked');
            const memberIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            if (!teamName.trim()) {
                alert('ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (memberIds.length < 4 || memberIds.length > 7) {
                alert('ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¯4-7äººã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/teams/${teamId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: teamName,
                        memberIds: memberIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ãƒãƒ¼ãƒ ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    closeEditTeamModal();
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('ãƒãƒ¼ãƒ æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }
        
        function closeEditTeamModal() {
            const modal = document.getElementById('editTeamModal');
            if (modal) {
                modal.remove();
            }
        }

        function exportParticipants() {
            const participants = <%-JSON.stringify(entries)%>;
            const csvContent = "data:text/csv;charset=utf-8," 
                + "åå‰,ãƒãƒ³ã‚¿ãƒ¼æ®µä½,ã‚µãƒã‚¤ãƒãƒ¼æ®µä½,Discord ID\n"
                + participants.map(p => `${p.username},${p.hunterRank},${p.survivorRank},${p.discordId}`).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `<%= tournament.title %>_participants.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getStatusText(status) {
            const statusMap = {
                'open': 'å‹Ÿé›†ä¸­',
                'closed': 'ç· åˆ‡',
                'ongoing': 'é–‹å‚¬ä¸­',
                'finished': 'çµ‚äº†'
            };
            return statusMap[status] || status;
        }
    </script>

    <% 
    function formatDate(date) {
        if (!date) return 'æœªè¨­å®š';
        let d;
        if (date.seconds) {
            d = new Date(date.seconds * 1000);
        } else {
            d = new Date(date);
        }
        return d.toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    %>
</body>
</html>