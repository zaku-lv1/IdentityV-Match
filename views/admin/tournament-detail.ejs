<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= tournament.title %> - ç®¡ç†ç”»é¢ | Identity V Tournament</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-brand">
                <h1><a href="/">Identity V Tournament</a></h1>
            </div>
            <div class="nav-links">
                <a href="/tournaments">å¤§ä¼šä¸€è¦§</a>
                <a href="/admin" class="active">ç®¡ç†ç”»é¢</a>
                <a href="/auth/logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="admin-header">
            <div class="tournament-title-section">
                <h1>ğŸ† <%= tournament.title %> - ç®¡ç†ç”»é¢</h1>
                <div class="tournament-status">
                    <span class="status-badge status-<%= tournament.status %>">
                        <%= tournament.status === 'open' ? 'å‹Ÿé›†ä¸­' : 
                            tournament.status === 'closed' ? 'ç· åˆ‡' : 
                            tournament.status === 'ongoing' ? 'é–‹å‚¬ä¸­' : 
                            tournament.status === 'finished' ? 'çµ‚äº†' : tournament.status %>
                    </span>
                </div>
            </div>
            <div class="admin-actions">
                <a href="/tournaments/<%= tournament.id %>" class="btn btn-outline">å…¬é–‹ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º</a>
                <a href="/admin/tournaments" class="btn btn-secondary">å¤§ä¼šä¸€è¦§ã«æˆ»ã‚‹</a>
            </div>
        </div>

        <div class="admin-content">
            <!-- Tournament Info Section -->
            <div class="info-section">
                <div class="info-card">
                    <h3>ğŸ“‹ å¤§ä¼šæƒ…å ±</h3>
                    <div class="info-list">
                        <div class="info-item">
                            <span class="info-label">æœ€å¤§å‚åŠ è€…æ•°</span>
                            <span class="info-value"><%= tournament.maxEntries %>äºº</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ¨å¥¨ãƒãƒ¼ãƒ ã‚µã‚¤ã‚º</span>
                            <span class="info-value"><%= tournament.teamSize %>äºº (4-7äººç·¨æˆå¯èƒ½)</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç· åˆ‡</span>
                            <span class="info-value"><%= formatDate(tournament.entryDeadline) %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ç¾åœ¨ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°</span>
                            <span class="info-value"><%= entries.length %>äºº</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ãƒãƒ¼ãƒ æ•°</span>
                            <span class="info-value"><%= teams.length %>ãƒãƒ¼ãƒ </span>
                        </div>
                    </div>
                </div>

                <!-- Status Management -->
                <div class="info-card">
                    <h3>ğŸ® å¤§ä¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</h3>
                    <div class="status-controls">
                        <button onclick="updateStatus('open')" class="btn btn-success" 
                                <%= tournament.status === 'open' ? 'disabled' : '' %>>
                            å‹Ÿé›†é–‹å§‹
                        </button>
                        <button onclick="updateStatus('closed')" class="btn btn-warning"
                                <%= tournament.status === 'closed' ? 'disabled' : '' %>>
                            å‹Ÿé›†ç· åˆ‡
                        </button>
                        <button onclick="updateStatus('ongoing')" class="btn btn-primary"
                                <%= tournament.status === 'ongoing' ? 'disabled' : '' %>>
                            å¤§ä¼šé–‹å§‹
                        </button>
                        <button onclick="updateStatus('finished')" class="btn btn-secondary"
                                <%= tournament.status === 'finished' ? 'disabled' : '' %>>
                            å¤§ä¼šçµ‚äº†
                        </button>
                    </div>
                </div>
            </div>

            <!-- Participants Management -->
            <div class="participants-section">
                <div class="participants-card">
                    <h3>ğŸ‘¥ å‚åŠ è€…ç®¡ç† (<%= entries.length %>äºº)</h3>
                    <% if (entries.length > 0) { %>
                        <div class="participants-controls">
                            <button onclick="createRandomTeams()" class="btn btn-primary">
                                ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒ¼ãƒ ä½œæˆ
                            </button>
                            <button onclick="showManualTeamCreation()" class="btn btn-secondary">
                                æ‰‹å‹•ãƒãƒ¼ãƒ ä½œæˆ
                            </button>
                            <button onclick="clearAllTeams()" class="btn btn-danger">
                                å…¨ãƒãƒ¼ãƒ è§£æ•£
                            </button>
                            <button onclick="exportParticipants()" class="btn btn-outline">
                                å‚åŠ è€…ãƒªã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                        </div>
                        
                        <div class="participants-list">
                            <% entries.forEach(entry => { %>
                                <div class="participant-item" id="participant-<%= entry.id %>">
                                    <div class="participant-info">
                                        <span class="participant-name"><%= entry.username %></span>
                                        <div class="participant-ranks">
                                            <span class="rank-badge hunter">H: <%= entry.hunterRank %>æ®µ</span>
                                            <span class="rank-badge survivor">S: <%= entry.survivorRank %>æ®µ</span>
                                        </div>
                                    </div>
                                    <div class="participant-actions">
                                        <button onclick="removeParticipant('<%= entry.id %>')" 
                                                class="btn btn-sm btn-danger">å‰Šé™¤</button>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p class="no-participants">ã¾ã å‚åŠ è€…ãŒã„ã¾ã›ã‚“</p>
                    <% } %>
                </div>
            </div>

            <!-- Teams Management -->
            <div class="teams-section">
                <div class="teams-card">
                    <h3>ğŸ¯ ãƒãƒ¼ãƒ ç®¡ç† (<%= teams.length %>ãƒãƒ¼ãƒ )</h3>
                    <div class="team-info-note">
                        <p>ğŸ’¡ ãƒãƒ¼ãƒ ç·¨æˆã¯4äººã§æ§‹æˆã—ã€4vs4ã®å¯¾æˆ¦ã‚’è¡Œã„ã¾ã™ã€‚æœ€ä½9äººã®å‚åŠ è€…ãŒå¿…è¦ã§ã™ã€‚</p>
                    </div>
                    
                    <% if (teams.length > 0) { %>
                        <div class="teams-list">
                            <% teams.forEach((team, index) => { %>
                                <div class="team-item" id="team-<%= team.id %>">
                                    <div class="team-header">
                                        <h4>ãƒãƒ¼ãƒ  <%= index + 1 %> (<%= team.members ? team.members.length : 0 %>äºº)</h4>
                                        <div class="team-actions">
                                            <button onclick="editTeam('<%= team.id %>')" class="btn btn-sm btn-primary">ç·¨é›†</button>
                                            <button onclick="deleteTeam('<%= team.id %>')" class="btn btn-sm btn-danger">å‰Šé™¤</button>
                                        </div>
                                    </div>
                                    <% if (team.members && team.members.length > 0) { %>
                                        <div class="team-members">
                                            <% team.members.forEach(member => { %>
                                                <div class="team-member">
                                                    <span class="member-name"><%= member.username %></span>
                                                    <div class="member-ranks">
                                                        <span class="rank-badge hunter">H: <%= member.hunterRank %>æ®µ</span>
                                                        <span class="rank-badge survivor">S: <%= member.survivorRank %>æ®µ</span>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        </div>
                                    <% } else { %>
                                        <p class="no-members">ãƒ¡ãƒ³ãƒãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                    <% } %>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <div class="no-teams">
                            <p>ã¾ã ãƒãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                            <% if (entries.length >= 9) { %>
                                <button onclick="createRandomTeams()" class="btn btn-primary">
                                    ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒ¼ãƒ ä½œæˆ
                                </button>
                            <% } else { %>
                                <p class="note">ãƒãƒ¼ãƒ ä½œæˆã«ã¯æœ€ä½9äººã®å‚åŠ è€…ãŒå¿…è¦ã§ã™</p>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </main>

    <!-- Manual Team Creation Modal -->
    <div id="manualTeamModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¯ æ‰‹å‹•ãƒãƒ¼ãƒ ä½œæˆ</h3>
                <span class="modal-close" onclick="closeManualTeamModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="team-creation-info">
                    <p>å‚åŠ è€…ã‚’é¸æŠã—ã¦ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚å„ãƒãƒ¼ãƒ ã¯4äººã§æ§‹æˆã•ã‚Œã¾ã™ã€‚</p>
                </div>
                <div id="teamCreationContainer">
                    <!-- Dynamic team creation forms will be inserted here -->
                </div>
                <div class="modal-actions">
                    <button onclick="addNewTeamForm()" class="btn btn-secondary">ãƒãƒ¼ãƒ è¿½åŠ </button>
                    <button onclick="removeLastTeamForm()" class="btn btn-danger">æœ€å¾Œã®ãƒãƒ¼ãƒ å‰Šé™¤</button>
                    <button onclick="createManualTeams()" class="btn btn-primary">ãƒãƒ¼ãƒ ã‚’ä½œæˆ</button>
                    <button onclick="closeManualTeamModal()" class="btn btn-outline">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .admin-header {
            margin-bottom: 3rem;
        }

        .tournament-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tournament-title-section h1 {
            color: #f39c12;
            font-size: 2.2rem;
        }

        .admin-actions {
            display: flex;
            gap: 1rem;
        }

        .admin-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .teams-section {
            grid-column: 1 / -1;
        }

        .info-card, .participants-card, .teams-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 2rem;
        }

        .info-card h3, .participants-card h3, .teams-card h3 {
            color: #f39c12;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .info-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-label {
            font-weight: bold;
            opacity: 0.8;
        }

        .info-value {
            color: #f39c12;
            font-weight: bold;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-open { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .status-closed { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .status-ongoing { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .status-finished { background: linear-gradient(45deg, #7f8c8d, #95a5a6); }

        .status-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .participants-controls {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .participants-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .participant-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .participant-ranks {
            display: flex;
            gap: 0.5rem;
        }

        .rank-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .rank-badge.hunter {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .rank-badge.survivor {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .team-info-note {
            background: rgba(52, 152, 219, 0.2);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border-left: 4px solid #3498db;
        }

        .team-info-note p {
            margin: 0;
            color: #3498db;
        }

        .teams-list {
            display: grid;
            gap: 1.5rem;
        }

        .team-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 15px;
            border: 2px solid rgba(243, 156, 18, 0.3);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .team-header h4 {
            color: #f39c12;
            margin: 0;
        }

        .team-actions {
            display: flex;
            gap: 0.5rem;
        }

        .team-members {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .team-member {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
        }

        .member-name {
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }

        .member-ranks {
            display: flex;
            gap: 0.5rem;
        }

        .no-participants, .no-members, .no-teams {
            text-align: center;
            opacity: 0.6;
            font-style: italic;
            padding: 2rem;
        }

        .no-teams .note {
            color: #f39c12;
            margin-top: 1rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .admin-content {
                grid-template-columns: 1fr;
            }
            
            .tournament-title-section {
                flex-direction: column;
                gap: 1rem;
            }

            .admin-actions {
                justify-content: center;
            }

            .status-controls, .participants-controls {
                justify-content: center;
            }

            .team-members {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h3 {
            color: #f39c12;
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 10px;
        }

        .modal-close:hover {
            color: #f39c12;
        }

        .modal-body {
            padding: 2rem;
        }

        .team-creation-info {
            background: rgba(52, 152, 219, 0.2);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border-left: 4px solid #3498db;
        }

        .team-creation-info p {
            margin: 0;
            color: #3498db;
        }

        .team-form {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border: 2px solid rgba(243, 156, 18, 0.3);
        }

        .team-form h4 {
            color: #f39c12;
            margin-bottom: 1rem;
        }

        .team-members-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .member-select {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 5px;
            padding: 0.8rem;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .member-select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
    </style>

    <script>
        const participants = <%-JSON.stringify(entries)%>;
        let teamCounter = 0;

        async function updateStatus(newStatus) {
            if (!confirm(`å¤§ä¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${getStatusText(newStatus)}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        async function removeParticipant(participantId) {
            if (!confirm('ã“ã®å‚åŠ è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/participants/${participantId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('å‚åŠ è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('å‚åŠ è€…å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        async function createRandomTeams() {
            if (participants.length < 9) {
                alert('ãƒ©ãƒ³ãƒ€ãƒ ãƒãƒ¼ãƒ ä½œæˆã«ã¯æœ€ä½9äººã®å‚åŠ è€…ãŒå¿…è¦ã§ã™');
                return;
            }

            if (!confirm('ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®ãƒãƒ¼ãƒ ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/teams/random`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert(`${result.teamsCreated}å€‹ã®ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ`);
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ãƒãƒ¼ãƒ ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        function showManualTeamCreation() {
            if (participants.length < 9) {
                alert('æ‰‹å‹•ãƒãƒ¼ãƒ ä½œæˆã«ã¯æœ€ä½9äººã®å‚åŠ è€…ãŒå¿…è¦ã§ã™');
                return;
            }

            document.getElementById('manualTeamModal').style.display = 'block';
            document.getElementById('teamCreationContainer').innerHTML = '';
            teamCounter = 0;
            
            // Add initial teams (2 teams for 4v4)
            addNewTeamForm();
            addNewTeamForm();
        }

        function closeManualTeamModal() {
            document.getElementById('manualTeamModal').style.display = 'none';
        }

        function addNewTeamForm() {
            teamCounter++;
            const container = document.getElementById('teamCreationContainer');
            
            const teamForm = document.createElement('div');
            teamForm.className = 'team-form';
            teamForm.id = `team-form-${teamCounter}`;
            
            teamForm.innerHTML = `
                <h4>ãƒãƒ¼ãƒ  ${teamCounter}</h4>
                <div class="team-members-selection">
                    ${Array.from({length: 4}, (_, i) => `
                        <select class="member-select" name="team${teamCounter}_member${i+1}">
                            <option value="">ãƒ¡ãƒ³ãƒãƒ¼${i+1}ã‚’é¸æŠ</option>
                            ${participants.map(p => `<option value="${p.discordId}">${p.username} (H:${p.hunterRank}æ®µ S:${p.survivorRank}æ®µ)</option>`).join('')}
                        </select>
                    `).join('')}
                </div>
            `;
            
            container.appendChild(teamForm);
        }

        function removeLastTeamForm() {
            if (teamCounter <= 2) {
                alert('æœ€ä½2ãƒãƒ¼ãƒ ã¯å¿…è¦ã§ã™');
                return;
            }
            
            const teamForm = document.getElementById(`team-form-${teamCounter}`);
            if (teamForm) {
                teamForm.remove();
                teamCounter--;
            }
        }

        async function createManualTeams() {
            const teams = [];
            const usedParticipants = new Set();
            
            // Collect team data
            for (let i = 1; i <= teamCounter; i++) {
                const teamForm = document.getElementById(`team-form-${i}`);
                if (!teamForm) continue;
                
                const members = [];
                const selects = teamForm.querySelectorAll('.member-select');
                
                for (const select of selects) {
                    if (select.value) {
                        if (usedParticipants.has(select.value)) {
                            alert(`å‚åŠ è€…ãŒé‡è¤‡ã—ã¦ã„ã¾ã™: ${select.options[select.selectedIndex].text}`);
                            return;
                        }
                        
                        const participant = participants.find(p => p.discordId === select.value);
                        if (participant) {
                            members.push(participant);
                            usedParticipants.add(select.value);
                        }
                    }
                }
                
                if (members.length > 0) {
                    teams.push({
                        name: `ãƒãƒ¼ãƒ ${i}`,
                        members: members
                    });
                }
            }
            
            if (teams.length < 2) {
                alert('æœ€ä½2ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }

            // Check if we have at least 8 participants in teams (4v4 minimum)
            const totalMembers = teams.reduce((sum, team) => sum + team.members.length, 0);
            if (totalMembers < 8) {
                alert('4vs4ã®å¯¾æˆ¦ã®ãŸã‚ã€æœ€ä½8äººãŒå¿…è¦ã§ã™');
                return;
            }

            if (!confirm(`${teams.length}å€‹ã®ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®ãƒãƒ¼ãƒ ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/teams/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ teams })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`${result.teamsCreated}å€‹ã®ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ`);
                    closeManualTeamModal();
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ãƒãƒ¼ãƒ ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        async function clearAllTeams() {
            if (!confirm('å…¨ã¦ã®ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/teams`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('å…¨ã¦ã®ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ãƒãƒ¼ãƒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        async function deleteTeam(teamId) {
            if (!confirm('ã“ã®ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/admin/tournaments/<%= tournament.id %>/teams/${teamId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    location.reload();
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('ãƒãƒ¼ãƒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                console.error(error);
            }
        }

        function editTeam(teamId) {
            // ãƒãƒ¼ãƒ ç·¨é›†æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®š
            alert('ãƒãƒ¼ãƒ ç·¨é›†æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™');
        }

        function exportParticipants() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "åå‰,ãƒãƒ³ã‚¿ãƒ¼æ®µä½,ã‚µãƒã‚¤ãƒãƒ¼æ®µä½,Discord ID\n"
                + participants.map(p => `${p.username},${p.hunterRank},${p.survivorRank},${p.discordId}`).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `<%= tournament.title %>_participants.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getStatusText(status) {
            const statusMap = {
                'open': 'å‹Ÿé›†ä¸­',
                'closed': 'ç· åˆ‡',
                'ongoing': 'é–‹å‚¬ä¸­',
                'finished': 'çµ‚äº†'
            };
            return statusMap[status] || status;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('manualTeamModal');
            if (event.target == modal) {
                closeManualTeamModal();
            }
        }
    </script>

    <% 
    function formatDate(date) {
        if (!date) return 'æœªè¨­å®š';
        let d;
        if (date.seconds) {
            d = new Date(date.seconds * 1000);
        } else {
            d = new Date(date);
        }
        return d.toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    %>
</body>
</html>