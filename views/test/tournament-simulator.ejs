<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ä¼šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - Identity V Match</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-brand">
                <h1><a href="/">Identity V Match</a></h1>
            </div>
            <div class="nav-links">
                <a href="/test/character-form">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ†ã‚¹ãƒˆ</a>
                <a href="/test/results">çµæœè¡¨ç¤º</a>
                <a href="/test/tournament-simulator" class="active">å¤§ä¼šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="page-header">
            <h2>ğŸ® å¤§ä¼šã‚·ã‚¹ãƒ†ãƒ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
            <p>å¤§ä¼šã®é€²è¡Œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã§ã™</p>
        </div>

        <div class="simulator-content">
            <!-- Quick Actions -->
            <div class="quick-actions card">
                <h3>âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <div class="action-buttons">
                    <button id="simulate-random-match" class="btn btn-primary">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ è©¦åˆç”Ÿæˆ</button>
                    <button id="create-test-series" class="btn btn-secondary">ğŸ“‹ ãƒ†ã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºä½œæˆ</button>
                    <button id="backup-data" class="btn btn-info">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                    <button id="clear-matches" class="btn btn-warning" onclick="confirmClearMatches()">ğŸ—‘ï¸ è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <!-- Current Tournament Status -->
            <div class="tournament-status card">
                <h3>ğŸ† ç¾åœ¨ã®å¤§ä¼šçŠ¶æ³</h3>
                <div class="tournaments-grid">
                    <% tournaments.forEach(tournament => { %>
                        <div class="tournament-card">
                            <h4><%= tournament.title %></h4>
                            <div class="tournament-info">
                                <p><strong>çŠ¶æ…‹:</strong> 
                                    <span class="status-badge <%= tournament.status %>"><%= tournament.status %></span>
                                </p>
                                <p><strong>æœ€å¤§ã‚¨ãƒ³ãƒˆãƒªãƒ¼:</strong> <%= tournament.maxEntries %>ãƒãƒ¼ãƒ </p>
                                <p><strong>ãƒãƒ¼ãƒ ã‚µã‚¤ã‚º:</strong> <%= tournament.teamSize %>äºº</p>
                            </div>
                            <div class="tournament-actions">
                                <button class="btn btn-sm btn-primary" onclick="simulateMatchForTournament('<%= tournament.id %>')">
                                    ğŸ¯ ã“ã®å¤§ä¼šã§è©¦åˆç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>

            <!-- Active Series -->
            <div class="series-status card">
                <h3>ğŸ“Š ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒªãƒ¼ã‚º</h3>
                <% if (allSeries.length === 0) { %>
                    <p class="no-data">ç¾åœ¨é€²è¡Œä¸­ã®ã‚·ãƒªãƒ¼ã‚ºã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <% } else { %>
                    <div class="series-list">
                        <% allSeries.forEach(series => { %>
                            <div class="series-card">
                                <div class="series-header">
                                    <h4><%= series.seriesTitle %></h4>
                                    <span class="series-type-badge"><%= series.seriesType %></span>
                                </div>
                                <div class="series-info">
                                    <p><strong>çŠ¶æ…‹:</strong> 
                                        <span class="status-badge <%= series.status %>"><%= series.status %></span>
                                    </p>
                                    <p><strong>ãƒãƒ¼ãƒ :</strong> <%= series.team1Name %> vs <%= series.team2Name %></p>
                                    <% if (series.games && series.games.length > 0) { %>
                                        <p><strong>è©¦åˆæ•°:</strong> <%= series.games.length %></p>
                                        <div class="game-results">
                                            <% series.games.forEach((game, index) => { %>
                                                <span class="game-result">
                                                    G<%= game.gameNumber %>: <%= game.hunterPoints %>-<%= game.survivorPoints %>
                                                    (<%= game.winner === 'team1' ? series.team1Name : series.team2Name %>)
                                                </span>
                                            <% }); %>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="series-actions">
                                    <button class="btn btn-sm btn-primary" onclick="simulateMatchForSeries('<%= series.id %>', '<%= series.tournamentId %>')">
                                        âš”ï¸ æ¬¡ã®è©¦åˆã‚’ç”Ÿæˆ
                                    </button>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } %>
            </div>

            <!-- Manual Match Creation -->
            <div class="manual-creation card">
                <h3>âœï¸ æ‰‹å‹•ã‚·ãƒªãƒ¼ã‚ºä½œæˆ</h3>
                <form id="create-series-form" class="create-series-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tournament-select">å¤§ä¼šé¸æŠ</label>
                            <select id="tournament-select" name="tournamentId" required>
                                <option value="">å¤§ä¼šã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                <% tournaments.forEach(tournament => { %>
                                    <option value="<%= tournament.id %>"><%= tournament.title %></option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="series-type">ã‚·ãƒªãƒ¼ã‚ºå½¢å¼</label>
                            <select id="series-type" name="seriesType" required>
                                <option value="BO1">BO1 (1æœ¬å‹è² )</option>
                                <option value="BO3" selected>BO3 (3æœ¬ä¸­2æœ¬å…ˆå–)</option>
                                <option value="BO5">BO5 (5æœ¬ä¸­3æœ¬å…ˆå–)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="team1-name">ãƒãƒ¼ãƒ 1å</label>
                            <input type="text" id="team1-name" name="team1Name" required placeholder="ãƒãƒ¼ãƒ A">
                        </div>
                        <div class="form-group">
                            <label for="team2-name">ãƒãƒ¼ãƒ 2å</label>
                            <input type="text" id="team2-name" name="team2Name" required placeholder="ãƒãƒ¼ãƒ B">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">ğŸ†• ã‚·ãƒªãƒ¼ã‚ºä½œæˆ</button>
                    </div>
                </form>
            </div>

            <!-- System Status -->
            <div class="system-status card">
                <h3>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
                <div class="status-info">
                    <div class="status-item">
                        <span class="status-label">ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–:</span>
                        <span class="status-value success">âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹æ°¸ç¶šåŒ–æœ‰åŠ¹</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ç’°å¢ƒ:</span>
                        <span class="status-value">ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:</span>
                        <span class="status-value">ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</span>
                    </div>
                </div>
                <p class="persistence-note">
                    ğŸ’¡ <strong>ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã«ã¤ã„ã¦:</strong> 
                    ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯è©¦åˆçµæœã‚„å¤§ä¼šãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€
                    ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã—ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¾ã™ã€‚
                </p>
            </div>
        </div>
    </main>

    <style>
        .simulator-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .quick-actions .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .tournaments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .tournament-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
        }

        .tournament-card h4 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
        }

        .tournament-info p {
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.open {
            background: var(--success-color);
            color: white;
        }

        .status-badge.ongoing {
            background: var(--warning-color);
            color: white;
        }

        .status-badge.completed {
            background: var(--info-color);
            color: white;
        }

        .series-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .series-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
        }

        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .series-header h4 {
            margin: 0;
            color: var(--accent-color);
        }

        .series-type-badge {
            background: var(--secondary-color);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .game-results {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .game-result {
            background: var(--border-color);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .system-status .status-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .status-value {
            font-family: monospace;
        }

        .status-value.success {
            color: var(--success-color);
        }

        .persistence-note {
            background: rgba(74, 144, 226, 0.1);
            border-left: 4px solid var(--info-color);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .no-data {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .series-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .status-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.2rem;
            }
        }
    </style>

    <script>
        // Simulate random match for any tournament
        document.getElementById('simulate-random-match').addEventListener('click', async () => {
            try {
                const tournaments = <%= JSON.stringify(tournaments.map(t => ({ id: t.id, title: t.title }))) %>;
                if (tournaments.length === 0) {
                    alert('å¤§ä¼šãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã¾ãšå¤§ä¼šã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                const randomTournament = tournaments[Math.floor(Math.random() * tournaments.length)];
                await simulateMatch(randomTournament.id, null);
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        });

        // Simulate match for specific tournament
        async function simulateMatchForTournament(tournamentId) {
            await simulateMatch(tournamentId, null);
        }

        // Simulate match for specific series
        async function simulateMatchForSeries(seriesId, tournamentId) {
            await simulateMatch(tournamentId, seriesId);
        }

        // Common simulate match function
        async function simulateMatch(tournamentId, seriesId) {
            try {
                const response = await fetch('/test/simulate-match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tournamentId, seriesId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ãƒ©ãƒ³ãƒ€ãƒ è©¦åˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼\n\nçµæœè¡¨ç¤ºãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚');
                    window.location.reload(); // Refresh to show updated series status
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('âŒ è©¦åˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // Create test series
        document.getElementById('create-series-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                const response = await fetch('/test/create-test-series', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ãƒ†ã‚¹ãƒˆã‚·ãƒªãƒ¼ã‚ºãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼');
                    e.target.reset();
                    window.location.reload();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('âŒ ã‚·ãƒªãƒ¼ã‚ºä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        });

        // Backup data
        document.getElementById('backup-data').addEventListener('click', async () => {
            try {
                const response = await fetch('/test/backup-data', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼\n\nãƒ•ã‚¡ã‚¤ãƒ«: ' + result.backupFile);
                } else {
                    alert('âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                alert('âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        });

        // Clear match data with confirmation
        async function confirmClearMatches() {
            if (confirm('âš ï¸ è­¦å‘Š: ã™ã¹ã¦ã®è©¦åˆçµæœãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    const response = await fetch('/test/clear-match-data', {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('âœ… è©¦åˆãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚\n\nå‰Šé™¤ã•ã‚ŒãŸè©¦åˆæ•°: ' + result.deletedCount);
                        window.location.reload();
                    } else {
                        alert('âŒ ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ' + result.error);
                    }
                } catch (error) {
                    alert('âŒ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>